



<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>flask-tutorial | 七翼式 | 不对称</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="theme-color" content="#3F51B5">
  
  
  <meta name="keywords" content="后端,flask">
  <meta name="description" content="#起因 最近简单看了flask的文档。 然后把里面教程的那一章敲了一遍。 敲完的代码放到了这里。 但是只是浮光掠影，对于flask还是不甚了解。 所以准备将这些代码中不懂的部分简单总结一下。虽然总结之后还是不懂，但总是方便查找了。 #概括 flask大概就是通过装饰器装饰函数，使用url调用该函数，返回值可以通过模板的方式合成html页面。 至于项目。 可以分为4个部分：  __init__.py">
<meta property="og:type" content="article">
<meta property="og:title" content="flask-tutorial">
<meta property="og:url" content="http://localhost:5000/2022/11/29/flask-tutorial/index.html">
<meta property="og:site_name" content="七翼式">
<meta property="og:description" content="#起因 最近简单看了flask的文档。 然后把里面教程的那一章敲了一遍。 敲完的代码放到了这里。 但是只是浮光掠影，对于flask还是不甚了解。 所以准备将这些代码中不懂的部分简单总结一下。虽然总结之后还是不懂，但总是方便查找了。 #概括 flask大概就是通过装饰器装饰函数，使用url调用该函数，返回值可以通过模板的方式合成html页面。 至于项目。 可以分为4个部分：  __init__.py">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-11-29T05:14:23.000Z">
<meta property="article:modified_time" content="2022-11-30T07:19:10.000Z">
<meta property="article:author" content="el_psy">
<meta property="article:tag" content="后端">
<meta property="article:tag" content="flask">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="七翼式" type="application/atom+xml">
  
  <meta name="summary" content="">
  <link rel="shortcut icon" href="/favicon/favicon.ico">
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"><link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head>

<body>
  <div id="loading" class="active"></div>

  <nav id="menu" class="hide" >
   <div class="inner flex-row-vertical">
  <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
      <i class="icon icon-lg icon-close"></i>
  </a>
  <div class="brand-wrap">
    <div class="brand">
      <a href="/" class="avatar"><img src="/img/logo.jpg"></a>
      <hgroup class="introduce">
        <h5 class="nickname">el_psy</h5>
        <a href="mailto:gaojingjingjing@outlook.com" title="gaojingjingjing@outlook.com" class="mail">gaojingjingjing@outlook.com</a>
      </hgroup>
    </div>
  </div>
  <div class="scroll-wrap flex-col">
    <ul class="nav">
      
          <li class="waves-block waves-effect">
            <a href="/"  >
              <i class="icon icon-lg icon-home"></i>
              主页
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/archives"  >
              <i class="icon icon-lg icon-archives"></i>
              archives
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/categories"  >
              <i class="icon icon-lg icon-th-list"></i>
              categories
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/tags"  >
              <i class="icon icon-lg icon-tags"></i>
              Tags
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="https://github.com/el-psy" target="_blank" >
              <i class="icon icon-lg icon-github"></i>
              Github
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/404"  >
              <i class="icon icon-lg icon-link"></i>
              测试
            </a>
          </li>
      
    </ul>

    <footer class="footer">
  <p><a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0;vertical-align:middle;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAAllBMVEUAAAD///+rsapERER3d3eIiIjMzMzu7u4iIiKUmZO6v7rKzsoODg4RERFVVVUNDQ0NDg0PEA8zMzNLTEtbXltmZmZydnF9gn2AgICPkI+ZmZmqqqq7u7vFxsXIzMgNDQwZGRkgICAhISEkJSMnKCcuMC4xMzE5Ozk7PTtBQkFCQkJDQ0Nna2eGhoaHh4ezuLLGysbd3d1wVGpAAAAA4UlEQVR42q2T1xqCMAyFk7QsBQeKA9x7j/d/OSm22CpX0nzcpA1/T05aAOuBVkMAScQFHLnEwoCo2f1TnQIGoVMewjZEjVFN4GH1Ue1Cn2jWqwfsOOj6wDwGvotsl/c8lv7KIq1eLOsT0HMFHMIE/RZyHnlphryT9zyV+8WH5e8yQw3wnQvgAFxPTKUVi555SHR/lOfLMgVTeDlSfN+TaoUsiTyeIm+bCkHvCA2FUKG48LDtYBZBknsYP/G8NTw0gaaHyuQf4H5pecrB/FYCT2sL9zAfy1Xyjou6L8X2W7YcLyBZCRtnq/zfAAAAAElFTkSuQmCC" /></a></p>
  <p>七翼式 &copy; 2022</p>
  <p>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme
  <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></p>
  <a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-2x icon-rss-square"></i></a>
</footer>

  </div>
</div>

  </nav>
  <main id="main">
    <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">flask-tutorial</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input " autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
    </div>
</header>
<header class="content-header">
  <div class="container">
    <h1 class="author">flask-tutorial</h1>
    <h5 class="subtitle">
        
            <time datetime="2022-11-29T05:14:23.000Z" itemprop="datePublished" class="page-time">
  2022-11-29
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/flask/">flask</a></li></ul></li></ul>

        
    </h5>
  </div>
</header>

    <div class="container body-wrap">
      <article id="post-flask-tutorial" 
  class="article article-type-post" itemprop="blogPost">
    <div class="post-meta flex-row">
        
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/" rel="tag">flask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag">后端</a></li></ul>

    </div>
    <div class="post-body">
        <aside class="post-widget" id="post-widget">

            
            <nav class="post-toc-wrap" id="post-toc">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E8%B5%B7%E5%9B%A0"><span class="post-toc-number">1.</span> <span class="post-toc-text">起因</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E6%A6%82%E6%8B%AC"><span class="post-toc-number">2.</span> <span class="post-toc-text">概括</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#init"><span class="post-toc-number">3.</span> <span class="post-toc-text">__init__</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#db"><span class="post-toc-number">4.</span> <span class="post-toc-text">db</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#auth"><span class="post-toc-number">5.</span> <span class="post-toc-text">auth</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#blog"><span class="post-toc-number">6.</span> <span class="post-toc-text">blog</span></a></li></ol>
            </nav>
            
        </aside>

        <div class="post-main">

            <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="起因"><a class="header-anchor" href="#起因">#</a>起因</h1>
<p>最近简单看了flask的文档。<br>
然后把里面<a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/tutorial/index.html">教程</a>的那一章敲了一遍。<br>
敲完的代码放到了<a target="_blank" rel="noopener" href="https://github.com/el-psy/flask-tutorial">这里</a>。<br>
但是只是浮光掠影，对于flask还是不甚了解。<br>
所以准备将这些代码中不懂的部分简单总结一下。虽然总结之后还是不懂，但总是方便查找了。</p>
<h1 id="概括"><a class="header-anchor" href="#概括">#</a>概括</h1>
<p>flask大概就是通过装饰器装饰函数，使用url调用该函数，返回值可以通过模板的方式合成html页面。<br>
至于项目。<br>
可以分为4个部分：</p>
<ul>
<li><code>__init__.py</code>主体部分。包括配置引入。</li>
<li><code>auth.py</code>认证部分。包括登录注册注销，以及一个装饰器，用于那些需要登录才能访问的url。</li>
<li><code>db.py</code>数据部分。包括连接数据库，初始化数据库，关闭数据库连接之类的。</li>
<li><code>blog.py</code>blog部分。主要功能所在。包括增加修改删除功能。</li>
</ul>
<h1 id="init"><a class="header-anchor" href="#init">#</a>__init__</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_app</span>(<span class="params">test_config=<span class="literal">None</span></span>):</span><br><span class="line">	app = Flask(__name__, instance_relative_config = <span class="literal">True</span>)</span><br><span class="line">	app.config.from_mapping(</span><br><span class="line">		SECRET_KEY = <span class="string">&#x27;dev&#x27;</span>,</span><br><span class="line">		DATABASE = os.path.join(app.instance_path, <span class="string">&#x27;flask.sqlite&#x27;</span>),</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">if</span> test_config <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">		app.config.from_pyfile(<span class="string">&#x27;config.py&#x27;</span>, silent = <span class="literal">True</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		app.config.from_mapping(test_config)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		os.makedirs(app.instance_path)</span><br><span class="line">	<span class="keyword">except</span> OSError:</span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">	@app.route(<span class="params"><span class="string">&#x27;/hello&#x27;</span></span>)</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;Hello, World!&#x27;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">from</span> . <span class="keyword">import</span> db</span><br><span class="line">	db.init_app(app)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">from</span> . <span class="keyword">import</span> auth</span><br><span class="line">	app.register_blueprint(auth.bp)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">from</span> . <span class="keyword">import</span> blog</span><br><span class="line">	app.register_blueprint(blog.bp)</span><br><span class="line">	app.add_url_rule(<span class="string">&#x27;/&#x27;</span>, endpoint=<span class="string">&#x27;index&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>
<ol>
<li><code>instance_relative_config</code></li>
</ol>
<blockquote>
<p>配置文件路径相关。默认是“相对于应用的根目录”，这个值为<code>True</code>的时候为“相对于实例文件夹”。</p>
</blockquote>
<ol start="2">
<li>SECRET_KEY</li>
</ol>
<blockquote>
<p>说是秘钥，但也没有明显发现其他代码哪里用到了。或许是<code>auth.py</code>中的<code>generate_password_hash</code>之类的？</p>
</blockquote>
<ol start="3">
<li>DATABASE</li>
</ol>
<blockquote>
<p>数据库文件路径。在<code>db.py</code>中使用。</p>
</blockquote>
<ol start="4">
<li>app.add_url_rule</li>
</ol>
<blockquote>
<p>完全看不懂</p>
</blockquote>
<h1 id="db"><a class="header-anchor" href="#db">#</a>db</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> click</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> current_app, g</span><br><span class="line"><span class="keyword">from</span> flask.cli <span class="keyword">import</span> with_appcontext</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_db</span>():</span><br><span class="line">	<span class="keyword">if</span> <span class="string">&#x27;db&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> g:</span><br><span class="line">		g.db = sqlite3.connect(</span><br><span class="line">			current_app.config[<span class="string">&#x27;DATABASE&#x27;</span>],</span><br><span class="line">			detect_types=sqlite3.PARSE_DECLTYPES</span><br><span class="line">		)</span><br><span class="line">		g.db.row_factory = sqlite3.Row</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> g.db</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">close_db</span>(<span class="params">e=<span class="literal">None</span></span>):</span><br><span class="line">	db = g.pop(<span class="string">&#x27;db&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">	<span class="keyword">if</span> db <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">		db.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_db</span>():</span><br><span class="line">	db = get_db()</span><br><span class="line">	<span class="keyword">with</span> current_app.open_resource(<span class="string">&#x27;schema.sql&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">		db.executescript(f.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@click.command(<span class="params"><span class="string">&#x27;init-db&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@with_appcontext</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_db_command</span>():</span><br><span class="line">	init_db()</span><br><span class="line">	click.echo(<span class="string">&#x27;Initialized the database.&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_app</span>(<span class="params">app</span>):</span><br><span class="line">	app.teardown_appcontext(close_db)</span><br><span class="line">	app.cli.add_command(init_db_command)</span><br></pre></td></tr></table></figure>
<ol>
<li>current_app</li>
</ol>
<blockquote>
<p>类型是LocalProxy<br>
像全局变量一样工作，但只能在处理请求期间且在处理它的线程中访问<br>
返回的栈顶元素不是应用上下文，而是flask的应用实例对象<br>
Flask 应用对象app具有config的属性，这些属性对于在视图或者在命令调试中访问很方便。但是现在项目的模块导入app 实例会容易出现循环导入的问题<br>
Flask 通过应用情景解决了这个问题，不是直接引用一个app，而是使用current_app 代理，该代理指向处理当前活动的应用；<br>
至于到底是什么我也不知道。。。感谢百度。</p>
</blockquote>
<ol start="2">
<li>g</li>
</ol>
<blockquote>
<p>flask的全局变量</p>
</blockquote>
<ol start="3">
<li>g.db.row_factory = sqlite3.Row</li>
</ol>
<blockquote>
<p>这样查询会返回 Row 对象，而不是字典。 Row 对象是 namedtuple ，因 此既可以通过索引访问也以通过键访问。</p>
</blockquote>
<ol start="4">
<li>current_app.open_resource</li>
</ol>
<blockquote>
<p>打开文件。相对于应用的相对路径。在<code>__init__.py</code>中设置过。</p>
</blockquote>
<ol start="5">
<li>with_appcontext</li>
</ol>
<blockquote>
<p>包装回调，以确保它能够与脚本的应用程序上下文一起执行。如果回调直接注册到app.cli对象，则默认情况下，除非禁用此函数，否则将使用此函数包装回调。</p>
</blockquote>
<ol start="6">
<li>app.teardown_appcontext</li>
</ol>
<blockquote>
<p>注册应用程序上下文结束时要调用的函数。当弹出请求上下文时，通常也会调用这些函数。</p>
</blockquote>
<ol start="7">
<li>init_app</li>
</ol>
<blockquote>
<p>最终注册的函数。</p>
</blockquote>
<h1 id="auth"><a class="header-anchor" href="#auth">#</a>auth</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bp = Blueprint(<span class="string">&#x27;auth&#x27;</span>, __name__, url_prefix=<span class="string">&#x27;/auth&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ol>
<li>所谓的蓝图</li>
</ol>
<blockquote>
<p>name=“auth” 蓝图的名称。将在每个端点名称前加上前缀。<br>
import_name=__name__ 蓝图包的名称，通常为__name__。这有助于定位蓝图的root_path。<br>
url_prefix=&quot;/auth&quot; 一个路径，用于在蓝图的所有URL前加上前缀，使其与应用程序的其他路径不同。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">	<span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span> :</span><br><span class="line">		username = request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">		password = request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">		db = get_db()</span><br><span class="line">		error = <span class="literal">None</span></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">			error = <span class="string">&#x27;Username is required.&#x27;</span></span><br><span class="line">		<span class="keyword">elif</span> <span class="keyword">not</span> password:</span><br><span class="line">			error = <span class="string">&#x27;Password is required.&#x27;</span></span><br><span class="line">		<span class="keyword">if</span> error <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				db.execute(</span><br><span class="line">					<span class="string">&#x27;insert into user (username, password) values (?, ?)&#x27;</span>,</span><br><span class="line">					(username, generate_password_hash(password)),</span><br><span class="line">				)</span><br><span class="line">				db.commit()</span><br><span class="line">			<span class="keyword">except</span> db.IntegrityError:</span><br><span class="line">				error = <span class="string">f&quot;User <span class="subst">&#123;username&#125;</span> is already registered.&quot;</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				<span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;auth.login&#x27;</span>))</span><br><span class="line">		flash(error)</span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;auth/register.html&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ol>
<li>request</li>
</ol>
<blockquote>
<p>请求体。试试文档api中的<code>Incoming Request Data</code>？</p>
</blockquote>
<ol start="2">
<li>db.execute</li>
</ol>
<blockquote>
<p>会进行字符串转换的。。</p>
</blockquote>
<ol start="3">
<li>generate_password_hash</li>
</ol>
<blockquote>
<p>加密</p>
</blockquote>
<ol start="4">
<li>flash</li>
</ol>
<blockquote>
<p>所谓的error提示。其实会在模板中会有体现。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">	<span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">		username = request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">		password = request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">		db = get_db()</span><br><span class="line">		error = <span class="literal">None</span></span><br><span class="line">		user = db.execute(</span><br><span class="line">			<span class="string">&#x27;select * from user where username = ?&#x27;</span>,</span><br><span class="line">			(username,)</span><br><span class="line">		).fetchone()</span><br><span class="line">		<span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">			error = <span class="string">&#x27;Incorrect username.&#x27;</span></span><br><span class="line">		<span class="keyword">elif</span> <span class="keyword">not</span> check_password_hash(user[<span class="string">&#x27;password&#x27;</span>], password):</span><br><span class="line">			error = <span class="string">&#x27;Incorrect password.&#x27;</span></span><br><span class="line">		<span class="keyword">if</span> error <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">			session.clear()</span><br><span class="line">			session[<span class="string">&#x27;user_id&#x27;</span>] = user[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">			<span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line">		flash(error)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;auth/login.html&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ol>
<li>check_password_hash</li>
</ol>
<blockquote>
<p>验证加密。</p>
</blockquote>
<ol start="2">
<li>session</li>
</ol>
<blockquote>
<p>session和cookie的作用有点类似，都是为了存储用户相关的信息的，区别在于 session 是保存在服务器端的，用 session_id 来标识用户。而 cookie 是保存在客户端，session 的出现，是为了解决 cookie 存储数据不安全的问题的。<br>
flask中的session机制是：把敏感数据经过加密后放入session中，然后再把session存放到cookie中，下次请求的时候，再从浏览器发送过来的cookie中读取session，然后再从session中读取敏感数据，并进行解密，获取最终的用户数据。<br>
使用session需要设置SECRET_KEY</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.before_app_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_logged_in_user</span>():</span><br><span class="line">	user_id = session.get(<span class="string">&#x27;user_id&#x27;</span>)</span><br><span class="line">	<span class="keyword">if</span> user_id <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">		g.user = <span class="literal">None</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		g.user = get_db().execute(</span><br><span class="line">			<span class="string">&#x27;select * from user where id = ?&#x27;</span>,</span><br><span class="line">			(user_id,)</span><br><span class="line">		).fetchone()</span><br></pre></td></tr></table></figure>
<ol>
<li>before_app_request</li>
</ol>
<blockquote>
<p>这样的函数在每次请求之前执行，即使在蓝图之外。</p>
</blockquote>
<ol start="2">
<li>g</li>
</ol>
<blockquote>
<p>别问我为什么需要将user数据设置在g里。我也不知道。。。<br>
2.1. 生命周期<br>
请求过来创建，请求结束销毁；<br>
仅适用于单次请求，g的生命周期即一个请求的生命周期<br>
注：和session不同，session是多个请求都可以使用的<br>
2.2. g是什么<br>
g相当于单次请求中的“全局变量”，能在单词请求中调用，但是和其他请求是互相隔离的<br>
可以参考上下文管理部分，g的创建与销毁流程理解<br>
2.3. g能做什么<br>
可以在单次请求中定义一些值和操作，随着本次请求结束而销毁；<br>
如，权限管理</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">	session.clear()</span><br><span class="line">	<span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br></pre></td></tr></table></figure>
<ol>
<li>session.clear()</li>
</ol>
<blockquote>
<p>清空session。cookie也随之清空。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">login_required</span>(<span class="params">view</span>):</span><br><span class="line"><span class="meta">	@functools.wraps(<span class="params">view</span>)</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">wrapped_view</span>(<span class="params">**kwargs</span>):</span><br><span class="line">		<span class="keyword">if</span> g.user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">			<span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;auth.login&#x27;</span>))</span><br><span class="line">		<span class="keyword">return</span> view(**kwargs)</span><br><span class="line">	<span class="keyword">return</span> wrapped_view</span><br></pre></td></tr></table></figure>
<ol>
<li>functools.wraps</li>
</ol>
<blockquote>
<p>首先这是一个装饰器，用于需要经过验证才能访问的url的。<br>
标准库 functools 中的 wrap 函数用于包装函数, 不改变原有函数的功能, 仅改变原有函数的一些属性, 例如 __name__, __doc__, __annotations__ 等属性<br>
我也不知道在这里使用到底有什么用。。</p>
</blockquote>
<h1 id="blog"><a class="header-anchor" href="#blog">#</a>blog</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> ( Blueprint, flash, g, redirect, render_template, request, url_for )</span><br><span class="line"><span class="keyword">from</span> werkzeug.exceptions <span class="keyword">import</span> abort</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flaskr.auth <span class="keyword">import</span> login_required</span><br><span class="line"><span class="keyword">from</span> flaskr.db <span class="keyword">import</span> get_db</span><br><span class="line"></span><br><span class="line">bp = Blueprint(<span class="string">&#x27;blog&#x27;</span>, __name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">	db = get_db()</span><br><span class="line">	posts = db.execute(</span><br><span class="line">		<span class="string">&#x27;select p.id, title, body, created, author_id, username from post p join user u on p.author_id = u.id order by created desc&#x27;</span></span><br><span class="line">	).fetchall()</span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;blog/index.html&#x27;</span>, posts = posts)</span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route(<span class="params"><span class="string">&#x27;/create&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>():</span><br><span class="line">	<span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">		title = request.form[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">		body = request.form[<span class="string">&#x27;body&#x27;</span>]</span><br><span class="line">		error = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> title:</span><br><span class="line">			error = <span class="string">&#x27;Title is required.&#x27;</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> error <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">			flash(error)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			db = get_db()</span><br><span class="line">			db.execute(</span><br><span class="line">				<span class="string">&#x27;insert into post (title, body, author_id) values (?,?,?)&#x27;</span>,</span><br><span class="line">				(title, body, g.user[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">			)</span><br><span class="line">			db.commit()</span><br><span class="line">			<span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;blog.index&#x27;</span>))</span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;blog/create.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_post</span>(<span class="params"><span class="built_in">id</span>, check_author = <span class="literal">True</span></span>):</span><br><span class="line">	post = get_db().execute(</span><br><span class="line">		<span class="string">&#x27;select p.id, title, body, created, author_id, username from post p join user u on p.author_id = u.id where p.id = ?&#x27;</span>,</span><br><span class="line">		(<span class="built_in">id</span>,)</span><br><span class="line">	).fetchone()</span><br><span class="line">	<span class="keyword">if</span> post <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">		abort(<span class="number">404</span>, <span class="string">f&#x27;Post id <span class="subst">&#123;<span class="built_in">id</span>&#125;</span> doesn\&#x27;t exist.&#x27;</span>)</span><br><span class="line">	<span class="keyword">if</span> check_author <span class="keyword">and</span> post[<span class="string">&#x27;author_id&#x27;</span>] != g.user[<span class="string">&#x27;id&#x27;</span>]:</span><br><span class="line">		abort(<span class="number">403</span>)</span><br><span class="line">	<span class="keyword">return</span> post</span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route(<span class="params"><span class="string">&#x27;/&lt;int:id&gt;/update&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">	post = get_post(<span class="built_in">id</span>)</span><br><span class="line">	<span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">		title = request.form[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">		body = request.form[<span class="string">&#x27;body&#x27;</span>]</span><br><span class="line">		error = <span class="literal">None</span></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> title:</span><br><span class="line">			error = <span class="string">&#x27;Title is required.&#x27;</span></span><br><span class="line">		<span class="keyword">if</span> error <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">			flash(error)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			db = get_db()</span><br><span class="line">			db.execute(</span><br><span class="line">				<span class="string">&#x27;update post set title = ?, body = ? where id = ?&#x27;</span>,</span><br><span class="line">				(title, body, <span class="built_in">id</span>)</span><br><span class="line">			)</span><br><span class="line">			db.commit()</span><br><span class="line">			<span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;blog.index&#x27;</span>))</span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;blog/update.html&#x27;</span>, post = post)</span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route(<span class="params"><span class="string">&#x27;/&lt;int:id&gt;/delete&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">	get_post(<span class="built_in">id</span>)</span><br><span class="line">	db = get_db()</span><br><span class="line">	db.execute(</span><br><span class="line">		<span class="string">&#x27;delete from post where id = ?&#x27;</span>, (<span class="built_in">id</span>,)</span><br><span class="line">	)</span><br><span class="line">	db.commit()</span><br><span class="line">	<span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;blog.index&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>最后的blog.py并没有什么要讲的。就是简单的crud。。</p>



            </div>
            
<nav class="post-nav">
  
    <div class="waves-block waves-effect prev fl">
      <a href="/2022/11/30/js-runtime/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">任务，微任务，事件循环以及js运行时理论篇</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next fr">
      <a href="/2022/11/24/frontend-bff-1/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Pattern: Backends For Frontends 翻译尝试</h4>
      </a>
    </div>
  
</nav>


            
            
        </div>
    </div>
</article>

    </div>
  </main>
<div class="mask" id="mask"></div>
<a href="#top" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>

<script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>


<script src="/js/main.js"></script>




<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<script type="text/template" id="search-tpl">
<li class="item">
    <a href="/{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</script>


<script src="/js/search.js"></script>










</body>
</html>
